# Testing the Duplicate Content Detection System in Xcode

This document outlines the workflow for testing the AWS integration and components of the Duplicate Content Detection (DCD) system within the Xcode development environment.

## 1. Opening the Project in Xcode

1.  **Ensure Dependencies are Installed**: Before opening Xcode, make sure all project dependencies are installed by running `make dependencies` in the project's root directory in your terminal.
2.  **Open the Workspace**: Double-click the `Signal.xcworkspace` file in Finder, or use the command line:
    ```bash
    open Signal.xcworkspace
    ```
3.  **Wait for Indexing/Package Resolution**: Allow Xcode to finish indexing the project and resolving any Swift Package Manager (SPM) dependencies.

## 2. Running Verification and Component Tests

Tests for the DCD system are located within the `DuplicateContentDetection` directory and potentially integrated into the main `SignalTests` or `SignalServiceKitTests` targets.

### 2.1 Running AWS Credential Verification Tests (`AwsCredentialsVerifier.swift`)

These tests validate the core AWS configuration and connectivity.

1.  **Navigate**: Open the Test Navigator (Cmd+6).
2.  **Locate**: Find the `AwsCredentialsVerifier` test class. It might be under a `DuplicateContentDetectionTests` target or integrated into `SignalServiceKitTests`.
3.  **Run**:
    *   To run all tests in the class: Click the play button next to the `AwsCredentialsVerifier` class name.
    *   To run a specific test method: Click the play button next to the individual test function (e.g., `testAWSCredentialsSetup`, `testDynamoDBConnectivity`).

### 2.2 Running GlobalSignatureService Tests (`test_global_signature_service.swift`)

These tests validate the `GlobalSignatureService`'s logic for interacting with the backend (hash checking, storing, deleting, batch operations).

1.  **Navigate**: Open the Test Navigator (Cmd+6).
2.  **Locate**: Find the `TestGlobalSignatureService` test class (likely within `SignalServiceKitTests` or a dedicated DCD test target). The standalone script `test_global_signature_service.swift` is primarily for command-line execution but the tests should also be integrated into an XCTest target.
3.  **Run**: Click the play button next to the `TestGlobalSignatureService` class or individual test methods (e.g., `testHashStorageAndRetrieval`, `testBatchOperations`).

### 2.3 Running AttachmentDownloadHook Tests (`test_attachment_download_hook.swift`)

These tests validate the hook that intercepts downloads and checks hashes using a mocked `GlobalSignatureService`.

1.  **Navigate**: Open the Test Navigator (Cmd+6).
2.  **Locate**: Find the `TestAttachmentDownloadHook` test class (likely within `SignalTests` or a dedicated DCD test target). Similar to GSS, the standalone script's tests should be part of an XCTest target.
3.  **Run**: Click the play button next to the `TestAttachmentDownloadHook` class or individual test methods (e.g., `testAttachmentValidation_Allowed`, `testAttachmentDownloadBlocking`).

### 2.4 Running Other Related Tests

*   **MessageSender Integration**: Locate `TestMessageSenderIntegration` (likely in `SignalServiceKitTests`) and run its tests to verify the pre-send check and post-send store logic.
*   **AWS Service Tests**: Locate `TestS3Service` and `TestLambdaService` and run their validation tests if needed (these primarily target configuration checks).

## 3. Interpreting Test Results and Logs

### 3.1 Xcode Test Results

*   **Test Navigator**: Shows a green checkmark (✅) for passed tests and a red 'x' (❌) for failed tests.
*   **Issue Navigator (Cmd+5)**: Displays detailed error messages and assertion failures for failed tests.
*   **Report Navigator (Cmd+9)**: Provides comprehensive logs for each test run, including console output and performance metrics.

### 3.2 Console Output

*   Monitor the Xcode console pane during test runs. The test classes (`AwsCredentialsVerifier`, `TestGlobalSignatureService`, etc.) use `swift-log` to output detailed information about their progress, assumptions (mock vs. real AWS), and specific checks being performed.
*   Look for logs indicating:
    *   AWS credential validation status.
    *   DynamoDB/API Gateway/S3 operation attempts and outcomes.
    *   Hash checking results (`contains` returning true/false).
    *   Hash storage attempts (`store` calls).
    *   Error messages from AWS SDK or custom error types (`MessageSenderError.duplicateBlocked`).

### 3.3 Log Files (`DuplicateContentDetection/Results/`)

*   **`aws_verification_results.log`**: Contains detailed results from `AwsCredentialsVerifier` runs, including specific checks for Cognito, DynamoDB, API Gateway. Useful for diagnosing fundamental AWS setup issues.
*   **`aws_dependency_verification.log`**: Log file generated by the standalone `AWSVerificationTestScript.swift`. Contains a summary and detailed results of AWS service checks.
*   **`aws_config_validation.log`**: Shows expected vs. detected AWS configuration values during tests.
*   Other logs (`duplicate_content_live_test_results.log`, etc.) capture results from specific test runs or scripts.

## 4. Key Files for Integration Verification

When debugging or verifying the DCD integration, check these key files in Xcode:

*   **`AppDelegate.swift`**: Ensure the AWS initialization block (`setupAWSCredentials`, `AWSCredentialsVerificationManager.verifyCredentialsAsync`) is correctly implemented and triggered.
*   **`AWSConfig.swift` (in `DuplicateContentDetection/Services/`)**: Verify region, table name, identity pool ID, and API endpoint constants match the target AWS environment. Check for placeholders.
*   **`GlobalSignatureService.swift` (in `SignalServiceKit/Network/`)**: Examine the `contains`, `store`, `delete`, `batchContains`, `batchImportHashes` methods for correct interaction logic with `APIGatewayClient` or direct AWS calls, and verify retry mechanisms.
*   **`APIGatewayClient.swift` (in `DuplicateContentDetection/Services/`)**: Check how requests are constructed, authenticated (headers), and retried.
*   **`AttachmentDownloadHook.swift` (in `Signal/Attachments/`)**: Verify hash computation and the call to `GlobalSignatureService.contains`. Check the default-allow logic on error.
*   **`MessageSender.swift` (in `SignalServiceKit/Messages/`)**: Look for the pre-send check (`GlobalSignatureService.contains`) and the post-send asynchronous call to `GlobalSignatureService.store`.

## 5. Testing with Mock vs. Real AWS Services

Several test files include a flag to control whether tests run against mock implementations or real AWS services:

*   **Flag**: `runValidationTestsAgainstRealAWS` (boolean constant within test classes like `TestGlobalSignatureService`, `TestS3Service`, `TestLambdaService`).
*   **Mock Mode (`false`)**:
    *   Tests run faster and don't require AWS credentials or incur costs.
    *   `AttachmentDownloadHookTests` and `TestMessageSenderIntegration` primarily use explicit mocks (`MockGlobalSignatureService`) and should work in this mode.
    *   Tests relying on direct AWS SDK calls (like parts of `TestGlobalSignatureService`, `TestS3Service`, `TestLambdaService`) will likely be skipped (`XCTSkip`) or may fail if they attempt AWS operations without valid credentials.
*   **Live Mode (`true`)**:
    *   Tests interact with the actual AWS services configured in `AWSConfig.swift`.
    *   **Requires valid AWS credentials** configured on the testing machine/environment (e.g., via environment variables, shared credentials file, or Cognito identity pool working correctly).
    *   Incurs AWS costs for DynamoDB reads/writes, API Gateway calls, etc.
    *   Provides the most realistic validation of the integration.
    *   Crucial for running tests like `AwsCredentialsVerifier` and the live interaction parts of `TestGlobalSignatureService`, `TestS3Service`, `TestLambdaService`.

**To Switch Modes**: Modify the `runValidationTestsAgainstRealAWS` flag directly in the respective test file before running the tests.

## 6. Success/Failure Indicators

*   **Overall Success**:
    *   All relevant tests in the Test Navigator show green checkmarks (✅).
    *   Xcode console logs indicate successful AWS initialization and operation completion without critical errors.
    *   Log files (`aws_verification_results.log`, etc.) show "PASSED" or "SUCCESS" status for key checks.
*   **Potential Failures**:
    *   Red 'x' (❌) next to tests in Test Navigator.
    *   Assertion failures reported in the Issue Navigator or test logs.
    *   Error messages in the console related to:
        *   AWS Authentication (Cognito errors, `NotAuthorizedException`).
        *   Network Connectivity (`NSURLErrorDomain`, timeouts).
        *   AWS Service Errors (DynamoDB `ProvisionedThroughputExceededException`, `ResourceNotFoundException`; API Gateway 4xx/5xx errors; S3 `AccessDenied`).
        *   Configuration Errors (Invalid region, table not found, incorrect endpoints).
        *   `MessageSenderError.duplicateBlocked` indicating the DCD system correctly blocked a send.
    *   Log files show "FAILED" or "ERROR" status, often with detailed error descriptions.
    *   App hangs or crashes during operations involving DCD components.

By following this workflow, developers can effectively test and validate the Duplicate Content Detection system's integration and functionality within the Xcode environment.