# AWS Functionality and Dependency Flow Analysis for Duplicate Content Detection

This document outlines the flow of AWS service interactions within the Signal iOS project, specifically for the Duplicate Content Detection (DCD) system. It details the configuration, dependencies, initialization process, and troubleshooting steps.

## 1. Overview of AWS Service Usage

The Duplicate Content Detection system leverages several AWS services to identify and potentially block duplicate media attachments:

-   **Amazon Cognito Identity:** Provides temporary, secure AWS credentials to the iOS client, allowing access to other AWS services without embedding long-term keys in the app.
-   **Amazon DynamoDB:** A NoSQL database used to store cryptographic hashes (SHA-256) of attachment content. The presence of a hash indicates the content has been seen before.
    -   Table Name: `SignalContentHashes`
    -   Primary Key: `ContentHash` (String)
    -   Attributes: `Timestamp`, `TTL` (Time-To-Live for automatic expiration)
-   **Amazon API Gateway:** Acts as the primary interface for the client to interact with the backend logic. It provides endpoints for checking (`contains`), storing (`store`), and deleting (`delete`) content hashes. Different endpoints might be used for different operations (e.g., a dedicated endpoint for `contains`).
-   **AWS Lambda (Implied):** While not directly called by the client code provided in this context, the presence of `TestLambdaService.swift` and the `signal-content-processor` function in `aws-config.json` suggest Lambda functions are likely triggered by API Gateway or S3 events to perform backend processing (e.g., validating hashes, updating DynamoDB).
-   **Amazon S3 (Implied):** The presence of `TestS3Service.swift` and `S3_BUCKET` environment variable in Lambda configuration implies S3 might be used for temporary storage or triggering processing workflows, although the core hash checking logic focuses on API Gateway/DynamoDB.

**Workflow:**
1.  When sending an attachment, the app computes its hash. It checks via API Gateway if the hash exists in DynamoDB. If blocked, the send fails. If not blocked and the send succeeds, the hash is stored via API Gateway.
2.  When downloading an attachment, the app computes its hash (or uses a provided one). It checks via API Gateway if the hash exists. If it exists, the download might be blocked or flagged.

## 2. Dependency Chain Analysis

The interaction with AWS follows this general dependency chain:

1.  **AppDelegate:** Initiates the AWS setup process upon application launch.
2.  **AWSConfig (in DuplicateContentDetection module):**
    -   Reads configuration constants (Region, Identity Pool ID, Table Name, API Endpoints).
    -   Contains the `setupAWSCredentials()` method, which configures the AWS SDK's default service manager with a `AWSCognitoCredentialsProvider`.
    -   Provides helper methods like `getDynamoDBClient()`, `getAPIGatewayHeaders()`, `validateAWSCredentials()`, `validateAPIGatewayConnectivity()`, `ensureDynamoDbTableExists()`, `calculateBackoffDelay()`.
3.  **AWSCredentialsVerificationManager:**
    -   Uses `AWSConfig` to verify credentials and connectivity.
    -   Calls `AWSConfig.validateAWSCredentials()`, `AWSConfig.validateAPIGatewayConnectivity()`, `AWSConfig.ensureDynamoDbTableExists()`, and directly interacts with DynamoDB via `AWSDynamoDB` client obtained from `AWSConfig` for deeper checks (e.g., `verifyTableStructure`).
4.  **GlobalSignatureService (in SignalServiceKit module):**
    -   The primary service used by application logic (e.g., `MessageSender`, `AttachmentDownloadHook`) to interact with the DCD backend.
    -   Likely uses `APIGatewayClient` internally (or direct URLSession calls using `AWSConfig` headers/endpoints) to make requests for `contains`, `store`, `delete` operations.
    -   Implements retry logic using `AWSConfig.calculateBackoffDelay()`.
    -   Handles batch operations potentially via `S3toDynamoDBImporter` and `BatchImportJobTracker`.
5.  **APIGatewayClient (in DuplicateContentDetection module):**
    -   A dedicated client for making authenticated requests to the configured API Gateway endpoints.
    -   Uses `URLSession` and incorporates headers generated by `AWSConfig.getAPIGatewayHeaders()`.
    -   Implements retry logic for API calls based on HTTP status codes and network errors, using `AWSConfig.calculateBackoffDelay()`.
6.  **AWS SDK (AWSCore, AWSCognitoIdentity, AWSDynamoDB, AWSAPIGateway, AWSLambda, AWSS3):** The underlying libraries that handle communication with AWS services based on the configuration provided by `AWSConfig`.

## 3. Key Configuration Parameters (aws-config.json -> AWSConfig.swift)

These parameters configure the AWS interaction:

-   **Region**: `us-east-1` (Used for Cognito, DynamoDB, API Gateway, Lambda, S3)
-   **CognitoIdentityPoolId**: `us-east-1:ee264a1b-9b89-4e4a-a346-9128da47af97` (For client authentication)
-   **DynamoDBTableName**: `SignalContentHashes` (Table storing the hashes)
-   **DynamoDBHashFieldName**: `ContentHash` (Primary key attribute name in DynamoDB)
-   **DynamoDBTTLFieldName**: `TTL` (Attribute name for Time-To-Live)
-   **DefaultTTLInDays**: `30` (Duration hashes are stored before automatic deletion)
-   **APIGatewayEndpoint**: URL for general operations (store/delete) - Placeholder: `https://YOUR_GENERAL_API_GATEWAY_ID.execute-api.us-east-1.amazonaws.com/Stage`
-   **GetTagApiGatewayEndpoint**: URL for checking hash existence - Placeholder: `https://YOUR_GETTAG_API_GATEWAY_ID.execute-api.us-east-1.amazonaws.com/Stage`
-   **ApiKey**: Placeholder: `YOUR_API_GATEWAY_API_KEY_PLACEHOLDER` (Required if API Gateway uses API Key auth)
-   **LambdaFunctionName**: `signal-content-processor` (Name of the backend processing function)
-   **LambdaFunctionArn**: `arn:aws:lambda:us-east-1:739874238091:function:ContentProcessor` (ARN of the Lambda function)
-   **S3BucketName**: `signal-content-attachments` (Likely used in backend Lambda/S3 workflows)
-   **Network Timeouts**: `requestTimeoutInterval` (10s), `resourceTimeoutInterval` (30s)
-   **Retry Logic**: `maxRetryCount` (3), `initialRetryDelay` (1s), `maxRetryDelay` (30s)

## 4. Connection Between AppDelegate and AWS Services

The `AppDelegate.application(_:didFinishLaunchingWithOptions:)` method orchestrates the initial AWS setup and verification:

1.  **Initialization Trigger**: Triggered after the main app environment and database are set up (`appReadiness.runNowOrWhenMainAppDidBecomeReadyAsync`).
2.  **Credential Setup**: Explicitly calls `DuplicateContentDetection.AWSConfig.setupAWSCredentials()` to configure the AWS SDK with the Cognito provider and region settings.
3.  **Verification**: Uses `AWSCredentialsVerificationManager.shared.verifyCredentialsAsync()` to:
    -   Confirm Cognito authentication works (fetches identity ID).
    -   Check connectivity to the configured API Gateway endpoints (`checkAPIGateway: true`).
    -   Verify the existence of the `SignalContentHashes` DynamoDB table (`verifyTableExists: true`).
4.  **Logging**: Logs the success or failure of the verification process, including any errors encountered.
5.  **Hook Installation**: Installs the `AttachmentDownloadHook` *regardless* of the verification outcome. The hook itself is responsible for checking the availability/validity of the `GlobalSignatureService` before acting.
6.  **Operational Mode**: Logs indicate that if verification fails, the DCD system might operate in a "degraded mode" (likely bypassing hash checks, effectively failing open).

## 5. Troubleshooting AWS Connectivity Issues

If AWS interactions fail, follow these steps:

1.  **Check Logs**: Examine the application logs (`AppDelegate`, `AWSConfig`, `AWSCredentialsVerificationManager`, `GlobalSignatureService`, `APIGatewayClient`) for specific error messages, codes, and domains (e.g., `AWSDynamoDBErrorDomain`, `NSURLErrorDomain`).
2.  **Run Verification Tests**: Execute the tests in `AwsCredentialsVerifier.swift`. Check the output in `DuplicateContentDetection/Results/aws_verification_results.log`. This log provides detailed status for Cognito, DynamoDB connectivity, table structure, and API Gateway reachability.
3.  **Check `aws_config_validation.log`**: This log compares expected vs. actual configuration values detected during tests.
4.  **Validate Configuration**: Ensure `AWSConfig.swift` constants match the intended deployment environment (Region, Identity Pool ID, Table Name, API Endpoints). Check for placeholder values (like API Key).
5.  **Check Network Connectivity**: Ensure the device has a stable internet connection. Test basic connectivity to AWS endpoints (e.g., `dynamodb.us-east-1.amazonaws.com`).
6.  **Verify API Gateway Endpoints**: Use tools like `curl` or Postman to check if the API Gateway URLs (`apiGatewayEndpoint`, `getTagApiGatewayEndpoint`) are reachable and respond (even with a 403 Forbidden if auth is missing/incorrect). Check CloudWatch logs for API Gateway if available.
7.  **Verify Cognito Identity Pool**: Confirm the `identityPoolId` exists in the correct region (`us-east-1`) and allows unauthenticated identities (or appropriate authenticated setup). Check IAM roles associated with the pool for necessary permissions (DynamoDB Put/Get/Delete on `SignalContentHashes`, API Gateway Invoke, Lambda Invoke, S3 access if needed).
8.  **Verify DynamoDB Table**: Check the AWS console to ensure the `SignalContentHashes` table exists in `us-east-1`, is in `ACTIVE` status, has the correct primary key (`ContentHash`), and has TTL enabled on the `TTL` attribute. Check provisioned capacity or ensure it's set to On-Demand (Pay-Per-Request).
9.  **Check IAM Permissions**: Review the IAM roles associated with the Cognito Identity Pool. Ensure they grant sufficient permissions:
    -   `dynamodb:GetItem`, `dynamodb:PutItem`, `dynamodb:DeleteItem` on the `SignalContentHashes` table ARN.
    -   `execute-api:Invoke` on the API Gateway ARN(s).
    -   `lambda:InvokeFunction` on the `signal-content-processor` Lambda ARN (if called directly or via API Gateway).
    -   S3 permissions (`s3:GetObject`, `s3:PutObject`) if used.
10. **Check AWS Service Status**: Consult the AWS Service Health Dashboard for outages in the `us-east-1` region.

## 6. Summary of Verification Tests and Expected Outcomes

-   **AwsCredentialsVerifier.swift**:
    -   **Purpose**: End-to-end validation of the AWS configuration and connectivity from the client's perspective.
    -   **Checks**: Cognito identity fetching, DynamoDB table existence and structure (`describeTable`), API Gateway endpoint reachability (`validateAPIGatewayConnectivity`), retry logic simulation.
    -   **Expected Outcome**: All checks pass successfully. The test logs results to `aws_verification_results.log`, confirming credentials are valid and all required services are reachable and configured correctly.
-   **TestS3Service.swift**:
    -   **Purpose**: Validates interaction with the configured S3 bucket (`signal-content-attachments`).
    -   **Checks**: Bucket existence/access (`HeadBucket`), file upload/download permissions, server-side encryption settings (`HeadObject`), lifecycle configuration retrieval (`GetBucketLifecycleConfiguration`).
    -   **Expected Outcome**: Basic operations (upload/download/head) succeed, confirming correct bucket configuration and permissions. Encryption should match `AES256`. Lifecycle retrieval should succeed (even if no rules exist). Requires `runValidationTestsAgainstRealAWS = true`.
-   **TestLambdaService.swift**:
    -   **Purpose**: Validates the configuration and invocation of the backend Lambda function (`signal-content-processor`).
    -   **Checks**: Function configuration retrieval (`GetFunctionConfiguration` - checks ARN, runtime, etc.), environment variable validation (`DYNAMODB_TABLE`, `S3_BUCKET`), basic invocation permission (`Invoke`), successful execution via `LambdaService` methods.
    -   **Expected Outcome**: Function configuration matches `aws-config.json`. Environment variables are correctly set. The function can be invoked successfully (returns HTTP 200 or expected function error), confirming correct setup and IAM permissions (`lambda:InvokeFunction`). Requires `runValidationTestsAgainstRealAWS = true`.
-   **test_global_signature_service.swift**:
    -   **Purpose**: Component test for the `GlobalSignatureService` logic.
    -   **Checks**: `contains`, `store`, `delete`, batch operations (`batchContains`, `batchImport`), metrics reporting. Tests concurrency and basic functionality. Uses mock `BatchImportJobTracker`. `batchContains` requires real AWS.
    -   **Expected Outcome**: Core operations succeed. Batch import uses mock tracker correctly. `batchContains` works against real API Gateway if enabled. Metrics are updated correctly. Requires `runValidationTestsAgainstRealAWS = true` for full coverage.
-   **test_attachment_download_hook.swift**:
    -   **Purpose**: Tests the `AttachmentDownloadHook`'s interaction with a mocked `GlobalSignatureService`.
    -   **Checks**: Hash computation consistency, validation logic (allowed vs. blocked based on mock GSS state), error handling (service error, data fetch error).
    -   **Expected Outcome**: Hook correctly calls mock GSS `contains`. Allows download if mock returns `false`. Blocks download and reports if mock returns `true`. Handles errors by defaulting to allow.
-   **test_message_sender_integration.swift**:
    -   **Purpose**: Tests the integration points where `MessageSender` (simulated/partially mocked) interacts with `GlobalSignatureService`.
    -   **Checks**: If `MessageSender` calls GSS `contains` before sending. If `MessageSender` calls GSS `store` after a successful send. If sending is blocked when GSS `contains` returns `true`. If messages without attachments bypass checks.
    -   **Expected Outcome**: `contains` is called before simulated send. `store` is called (async) after simulated successful send. Send simulation fails with `MessageSenderError.duplicateBlocked` if `contains` returns `true`. No GSS calls for messages without attachments. Relies on *simulating* `MessageSender`'s logic and potentially mocking the GSS singleton.